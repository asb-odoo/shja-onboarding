<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!--Form view of Sale_Proposal-->
    <record id="sale_view_order_form_inherit_sale_proposal" model="ir.ui.view">
        <field name="name">sale.order.form.inherit.sale.proposal</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//form/header/button[@name='action_draft']" position="after">
                <field name="state_proposal" widget="statusbar"/>
            </xpath>

            <xpath expr="//form//button[@name='action_draft']" position="before">
                <button name="action_approve"
                        string="APPROVE" type="object" class="btn-success"
                        attrs="{'invisible': ['|',('state_proposal', '!=', 'send'),('proposal_status','!=','not_approved')]}"/>
            </xpath>

            <xpath expr="//form//button[@name='action_approve']" position="after">
                <button name="action_reject"
                        string="REJECT"
                        type="object"
                        class="btn-danger"
                        attrs="{'invisible': ['|',('state_proposal', '=', 'draft'),('proposal_status','!=','not_approved')]}"/>
            </xpath>

            <xpath expr="//form//button[@name='action_confirm'][1]" position="replace">
                <button name="action_confirm"
                        string="Confirm"
                        type="object"
                        attrs="{'invisible': ['|',('state_proposal', 'in', ['draft','confirm']),('proposal_status','not in',['approved'])]}"/>
            </xpath>

            <xpath expr="//form//button[@name='action_cancel'][1]" position="replace">
                <button name="action_cancel"
                        string="Cancel"
                        type="object"
                        attrs="{'invisible': ['|',('state_proposal', 'in', ['send']),('proposal_status','not in',['approved'])]}"/>
            </xpath>

           <xpath expr="//form//button[@name='action_confirm'][2]" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//page[@name='optional_products']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//notebook/page[@name='order_lines']/field[@name='order_line']/tree//field[@name='product_uom_qty']"
                   position="after">
                <field name="accepted_quantity"
                       attrs="{'column_invisible': [('parent.state_proposal', '=', 'draft')]}"
                       style="color:Green;"/>
            </xpath>

            <xpath expr="//notebook/page[@name='order_lines']/field[@name='order_line']/tree//field[@name='price_unit']"
                   position="after">
                <field name="accepted_price"
                       attrs="{'column_invisible': [('parent.state_proposal', '=', 'draft')]}"
                       style="color:Green;"/>
            </xpath>

            <xpath expr="//notebook/page[@name='order_lines']/field[@name='order_line']/tree//field[@name='price_subtotal']"
                   position="after">
                <field name="proposal_subtotal"
                       attrs="{'column_invisible': ['|',('parent.state_proposal', '=', 'draft'),('parent.state', '=', 'sale')]}"
                       style="color:Green;"/>
            </xpath>

            <xpath expr="//notebook/page[@name='order_lines']/field[@name='order_line']/tree//field[@name='price_unit']"
                   position="replace">
                <field name="price_unit"
                       attrs="{'readonly': [('parent.state_proposal', '=', 'send')]}"/>
            </xpath>

            <xpath expr="//notebook/page[@name='order_lines']/field[@name='order_line']/tree//field[@name='product_uom_qty']"
                   position="replace">
                <field name="product_uom_qty"
                       attrs="{'readonly': [('parent.state_proposal', '=', 'send')]}"/>
            </xpath>

            <xpath expr="//page[@name='other_information']" position="replace">
                <page string="Other Info" name="other_information">
                    <field name="company_id"
                           options="{'no_create': True}" groups="base.group_multi_company"
                           invisible="1"/>
                    <field name="require_signature" invisible="1"/>
                    <field name="invoice_status"
                           states="sale,done" groups="base.group_no_one" invisible="1"/>
                    <group>
                        <field name="proposal_status" readonly="1"/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!--Tree View Of Sale Proposal-->
    <record id="sale_view_order_tree_inherit_sale_proposal" model="ir.ui.view">
        <field name="name">sale.order.view.tree.inherited.sale.proposal</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_quotation_tree"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <xpath expr="//tree" position="replace">
                <tree string="Proposal"  sample="1" decoration-info="state in ['draft', 'send']">
                    <field name="name" string="Number" readonly="1" decoration-bf="1"/>
                    <field name="state" invisible="1" decoration-success="state == 'sale' or state == 'done'"
                           decoration-info="state == 'draft' or state == 'sent'" widget="badge" optional="show"/>
                    <field name="state_proposal"/>
                </tree>
            </xpath>
        </field>
    </record>

    <!-- Action View of Sale Proposal -->
    <record id="sale_proposal_action" model="ir.actions.act_window">
        <field name="name">Sale Proposal</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">tree,form</field>
        <field name="view_ids" eval="[(5, 0, 0),
                 (0, 0, {'view_mode': 'tree', 'view_id': ref('sale_view_order_tree_inherit_sale_proposal')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('sale_view_order_form_inherit_sale_proposal')})]"/>
<!--        <field name="context">{'default_order_type':'Proposal'}</field>-->
        <field name="domain">[("name","ilike",'Proposal')]</field>
    </record>

    <!--Menu of Sale Proposal-->
    <menuitem action="sale_proposal_action"
              id="sale_proposal_menu"
              name="Sale Proposal"
              parent="sale.sale_order_menu"
              sequence="5"/>
</odoo>

